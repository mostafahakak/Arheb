<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arheb API Test Client</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1rem;
      color: #1a202c;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2rem;
      font-weight: 700;
    }

    header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1rem;
    }

    .content {
      display: grid;
      grid-template-columns: 300px 1fr;
      min-height: calc(100vh - 200px);
    }

    .sidebar {
      background: #f7fafc;
      border-right: 1px solid #e2e8f0;
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .sidebar h2 {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #718096;
      margin: 0 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .nav-item {
      display: block;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      text-decoration: none;
      color: #2d3748;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-item:hover {
      background: #edf2f7;
      border-color: #667eea;
      transform: translateX(4px);
    }

    .nav-item.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .main-content {
      padding: 2rem;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .section {
      display: none;
      animation: fadeIn 0.3s;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 1.5rem 0;
      color: #1a202c;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
      color: #2d3748;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 0.5rem;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .row input {
      flex: 1;
      min-width: 200px;
    }

    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: #667eea;
      color: white;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: #718096;
    }

    button.secondary:hover {
      background: #5a67d8;
    }

    button.danger {
      background: #e53e3e;
    }

    button.danger:hover {
      background: #c53030;
    }

    button.success {
      background: #38a169;
    }

    button.success:hover {
      background: #2f855a;
    }

    .output {
      background: #1a202c;
      color: #68d391;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 1rem;
    }

    .status {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .status.info {
      background: #bee3f8;
      color: #2c5282;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .badge.auth {
      background: #fed7d7;
      color: #742a2a;
    }

    .badge.public {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge.admin {
      background: #feebc8;
      color: #7c2d12;
    }

    #recaptcha-container {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 4px solid;
    }

    .alert.info {
      background: #ebf8ff;
      border-color: #3182ce;
      color: #2c5282;
    }

    #mapContainer {
      position: relative;
    }

    .location-marker {
      font-size: 32px;
      transform: rotate(0deg);
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
      }

      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ Arheb API Test Client</h1>
      <p>Comprehensive testing interface for all API endpoints</p>
    </header>

    <div class="content">
      <nav class="sidebar">
        <h2>Navigation</h2>
        <a class="nav-item active" data-section="auth">üîê Authentication</a>
        <a class="nav-item" data-section="products">üì¶ Products</a>
        <a class="nav-item" data-section="stores">üè™ Stores</a>
        <a class="nav-item" data-section="categories">üìÇ Categories</a>
        <a class="nav-item" data-section="home">üè† Home</a>
        <a class="nav-item" data-section="profile">üë§ Profile</a>
        <a class="nav-item" data-section="checkout">üõí Checkout & Orders</a>
        <a class="nav-item" data-section="tracking">üöö Order Tracking</a>
        <a class="nav-item" data-section="promo">üé´ Promo Codes</a>
        <a class="nav-item" data-section="contact">üìû Contact</a>
      </nav>

      <div class="main-content">
        <!-- Authentication Section -->
        <section id="auth" class="section active">
          <h2>Authentication <span class="badge public">Public</span></h2>
          
          <div class="card">
            <h3>Register / Send OTP</h3>
            <div class="form-group">
              <label for="phoneInput">Phone Number</label>
              <input id="phoneInput" type="tel" value="+201500157920" placeholder="+201500157920" />
            </div>
            <button id="sendOtpBtn">Request OTP</button>
            <div id="registerStatus" class="status info" style="display: none;"></div>
            <div id="registerOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Verify OTP</h3>
            <div class="form-group">
              <label for="sessionInfoInput">Session Info</label>
              <textarea id="sessionInfoInput" rows="3" placeholder="Paste sessionInfo from register response"></textarea>
            </div>
            <div class="form-group">
              <label for="otpInput">OTP Code</label>
              <input id="otpInput" type="text" value="111111" placeholder="111111" />
            </div>
            <button id="verifyOtpBtn" class="secondary">Verify OTP</button>
            <div id="verifyStatus" class="status info" style="display: none;"></div>
            <div id="verifyOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Delete User <span class="badge auth">Auth Required</span></h3>
            <button id="deleteUserBtn" class="danger">Delete User</button>
            <div id="deleteOutput" class="output" style="display: none;"></div>
          </div>

          <div id="recaptcha-container"></div>
        </section>

        <!-- Products Section -->
        <section id="products" class="section">
          <h2>Products <span class="badge public">Public</span></h2>
          
          <div class="card">
            <h3>Get Products (Paginated)</h3>
            <div class="form-group">
              <label for="productsPage">Page Number</label>
              <input id="productsPage" type="number" value="1" min="1" />
            </div>
            <button id="fetchProductsBtn">Fetch Products</button>
            <div id="productsOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Get Product by ID</h3>
            <div class="form-group">
              <label for="productId">Product ID</label>
              <input id="productId" type="text" placeholder="Enter product ID" />
            </div>
            <button id="getProductByIdBtn" class="secondary">Get Product</button>
            <div id="productByIdOutput" class="output" style="display: none;"></div>
          </div>
        </section>

        <!-- Stores Section -->
        <section id="stores" class="section">
          <h2>Stores <span class="badge public">Public</span></h2>
          
          <div class="card">
            <h3>Get All Stores</h3>
            <button id="fetchStoresBtn">Fetch All Stores</button>
            <div id="storesOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Get Top Rated Stores</h3>
            <div class="form-group">
              <label for="topRatedLimit">Limit (optional)</label>
              <input id="topRatedLimit" type="number" placeholder="Leave empty for all" />
            </div>
            <button id="fetchTopRatedBtn" class="secondary">Fetch Top Rated</button>
            <div id="topRatedOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Get Store Products</h3>
            <div class="form-group">
              <label for="storeIdForProducts">Store ID</label>
              <input id="storeIdForProducts" type="text" placeholder="Enter store ID" />
            </div>
            <button id="getStoreProductsBtn" class="secondary">Get Store Products</button>
            <div id="storeProductsOutput" class="output" style="display: none;"></div>
          </div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="section">
          <h2>Categories <span class="badge public">Public</span></h2>
          <div class="card">
            <h3>Get All Categories</h3>
            <button id="fetchCategoriesBtn">Fetch Categories</button>
            <div id="categoriesOutput" class="output" style="display: none;"></div>
          </div>
        </section>

        <!-- Home Section -->
        <section id="home" class="section">
          <h2>Home <span class="badge public">Public</span></h2>
          <div class="card">
            <h3>Get Home Data</h3>
            <button id="fetchHomeBtn">Fetch Home Data</button>
            <div id="homeOutput" class="output" style="display: none;"></div>
          </div>
        </section>

        <!-- Profile Section -->
        <section id="profile" class="section">
          <h2>Profile <span class="badge auth">Auth Required</span></h2>
          
          <div class="card">
            <h3>Get Profile</h3>
            <button id="getProfileBtn">Get My Profile</button>
            <div id="profileOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Update Profile</h3>
            <div class="form-group">
              <label for="profileNameInput">Name</label>
              <input id="profileNameInput" type="text" placeholder="Full name" />
            </div>
            <div class="form-group">
              <label for="profileAddressNameInput">Address Name</label>
              <input id="profileAddressNameInput" type="text" placeholder="Home, Work, etc." />
            </div>
            <div class="row">
              <div class="form-group" style="flex: 1;">
                <label for="profileAddressLongInput">Longitude</label>
                <input id="profileAddressLongInput" type="number" step="any" placeholder="35.0063" />
              </div>
              <div class="form-group" style="flex: 1;">
                <label for="profileAddressLatInput">Latitude</label>
                <input id="profileAddressLatInput" type="number" step="any" placeholder="29.5320" />
              </div>
            </div>
            <button id="updateProfileBtn" class="secondary">Update Profile</button>
          </div>
        </section>

        <!-- Checkout Section -->
        <section id="checkout" class="section">
          <h2>Checkout & Orders <span class="badge auth">Auth Required</span></h2>
          
          <div class="card">
            <h3>Create Order</h3>
            <div class="form-group">
              <label for="checkoutDataInput">Order Data (JSON)</label>
              <textarea id="checkoutDataInput" rows="12" placeholder='{"items": [...], "phoneNumber": "...", "totalAmount": 15.5, "deliveryFee": 2.5, "paymentType": "cash"}'></textarea>
            </div>
            <div class="row">
              <button id="fillDummyDataBtn" class="secondary">Fill Dummy Data</button>
              <button id="createOrderBtn" class="success">Create Order</button>
            </div>
            <div id="checkoutOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Get All Orders</h3>
            <button id="getAllOrdersBtn" class="secondary">Get My Orders</button>
            <div id="allOrdersOutput" class="output" style="display: none;"></div>
          </div>

          <div class="grid-2">
            <div class="card">
              <h3>Get Order by ID</h3>
              <div class="form-group">
                <label for="orderIdInput">Order ID</label>
                <input id="orderIdInput" type="number" placeholder="1" />
              </div>
              <button id="getOrderBtn" class="secondary">Get Order</button>
              <div id="orderByIdOutput" class="output" style="display: none;"></div>
            </div>

            <div class="card">
              <h3>Rate Order</h3>
              <div class="form-group">
                <label for="rateOrderId">Order ID</label>
                <input id="rateOrderId" type="number" placeholder="1" />
              </div>
              <div class="form-group">
                <label for="orderRating">Rating (1-5)</label>
                <input id="orderRating" type="number" min="1" max="5" value="5" />
              </div>
              <button id="rateOrderBtn" class="success">Rate Order</button>
              <div id="rateOrderOutput" class="output" style="display: none;"></div>
            </div>
          </div>
        </section>

        <!-- Order Tracking Section -->
        <section id="tracking" class="section">
          <h2>Order Tracking <span class="badge auth">Auth Required</span></h2>
          
          <div class="card">
            <h3>Connect to Order Tracking</h3>
            <div class="form-group">
              <label for="trackingOrderId">Order ID</label>
              <input id="trackingOrderId" type="number" placeholder="1" />
            </div>
            <div class="row">
              <button id="connectAsDriverBtn" class="success">Connect as Driver</button>
              <button id="connectAsCustomerBtn" class="secondary">Connect as Customer</button>
              <button id="disconnectTrackingBtn" class="danger">Disconnect</button>
            </div>
            <div id="trackingStatus" class="status info" style="display: none; margin-top: 0.5rem;"></div>
          </div>

          <div class="card">
            <h3>Map View (Customer)</h3>
            <div id="mapContainer" style="height: 500px; width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; display: none;">
              <div id="trackingMap" style="height: 100%; width: 100%;"></div>
            </div>
            <div id="trackingInfo" style="margin-top: 1rem; display: none;">
              <div class="status info">
                <strong>Last Update:</strong> <span id="lastUpdateTime">-</span><br>
                <strong>Coordinates:</strong> <span id="currentCoords">-</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Driver Location Log</h3>
            <div id="trackingOutput" class="output" style="max-height: 300px; display: none;"></div>
          </div>
        </section>

        <!-- Promo Codes Section -->
        <section id="promo" class="section">
          <h2>Promo Codes <span class="badge public">Public</span></h2>
          <div class="card">
            <h3>Validate Promo Code</h3>
            <div class="form-group">
              <label for="promoCodeInput">Promo Code</label>
              <input id="promoCodeInput" type="text" placeholder="SAVE10" />
            </div>
            <button id="validatePromoBtn">Validate Promo Code</button>
            <div id="promoOutput" class="output" style="display: none;"></div>
          </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="section">
          <h2>Contact <span class="badge public">Public / <span class="badge admin">Admin</span></span></h2>
          
          <div class="card">
            <h3>Get Contact Information</h3>
            <button id="getContactBtn">Get Contact Info</button>
            <div id="contactOutput" class="output" style="display: none;"></div>
          </div>

          <div class="card">
            <h3>Update Contact Information <span class="badge admin">Admin Only</span></h3>
            <div class="form-group">
              <label for="contactEmail">Email</label>
              <input id="contactEmail" type="email" placeholder="contact@arheb.com" />
            </div>
            <div class="form-group">
              <label for="contactPhone">Phone</label>
              <input id="contactPhone" type="tel" placeholder="+201234567890" />
            </div>
            <button id="updateContactBtn" class="secondary">Update Contact</button>
            <div id="updateContactOutput" class="output" style="display: none;"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    const sdkUrls = [
      "./vendor/firebase-app-compat.js",
      "./vendor/firebase-auth-compat.js",
    ];
    const backendBase = window.location.origin;
    let lastAppToken = "";
    let lastFirebaseToken = "";
    let verifier;

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const section = item.dataset.section;
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(section).classList.add('active');
      });
    });

    // Helper functions
    function showOutput(elementId, data) {
      const el = document.getElementById(elementId);
      el.textContent = JSON.stringify(data, null, 2);
      el.style.display = 'block';
    }

    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `status ${type}`;
      el.style.display = 'block';
    }

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const tag = document.createElement("script");
        tag.src = url;
        tag.onload = resolve;
        tag.onerror = () => reject(new Error(`failed to load ${url}`));
        document.head.appendChild(tag);
      });
    }

    async function bootstrap() {
      for (const url of sdkUrls) {
        await loadScript(url);
      }

      const firebaseConfig = {
        apiKey: "AIzaSyA_rR3EE0ncBTdkRrpOrYy7S1nQXjvf5EQ",
        authDomain: "arheb-bd219.firebaseapp.com",
        projectId: "arheb-bd219",
        storageBucket: "arheb-bd219.appspot.com",
        messagingSenderId: "1050116933276",
        appId: "1:1050116933276:web:abdeb6b2f3e13409a00f59",
      };

      firebase.initializeApp(firebaseConfig);

      function setupVerifier() {
        if (verifier) verifier.clear();
        verifier = new firebase.auth.RecaptchaVerifier("recaptcha-container", {
          size: "normal",
        });
        verifier.render().catch(console.error);
      }

      // Authentication
      document.getElementById('sendOtpBtn').addEventListener('click', async () => {
        const phone = document.getElementById('phoneInput').value.trim();
        showStatus('registerStatus', 'Preparing reCAPTCHA...', 'info');
        try {
          const recaptchaToken = await verifier.verify();
          showStatus('registerStatus', 'Sending request...', 'info');
          const res = await fetch(`${backendBase}/api/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phoneNumber: phone, recaptchaToken }),
          });
          const data = await res.json();
          showOutput('registerOutput', data);
          if (data.sessionInfo) {
            document.getElementById('sessionInfoInput').value = data.sessionInfo;
          }
          showStatus('registerStatus', res.ok ? 'OTP sent successfully!' : 'Failed to send OTP', res.ok ? 'success' : 'error');
        } catch (error) {
          showStatus('registerStatus', `Error: ${error.message}`, 'error');
        } finally {
          setupVerifier();
        }
      });

      document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
        const sessionInfo = document.getElementById('sessionInfoInput').value.trim();
        const otp = document.getElementById('otpInput').value.trim();
        const phone = document.getElementById('phoneInput').value.trim();
        if (!sessionInfo) {
          showStatus('verifyStatus', 'Please paste sessionInfo first', 'error');
          return;
        }
        showStatus('verifyStatus', 'Verifying OTP...', 'info');
        try {
          const res = await fetch(`${backendBase}/api/auth/verify-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phoneNumber: phone, sessionInfo, otp }),
          });
          const data = await res.json();
          showOutput('verifyOutput', data);
          if (data.success) {
            lastAppToken = data.token;
            lastFirebaseToken = data.firebaseToken || '';
            showStatus('verifyStatus', 'Logged in successfully! Token saved.', 'success');
          } else {
            showStatus('verifyStatus', 'Verification failed', 'error');
          }
        } catch (error) {
          showStatus('verifyStatus', `Error: ${error.message}`, 'error');
        }
      });

      document.getElementById('deleteUserBtn').addEventListener('click', async () => {
        if (!lastAppToken || !lastFirebaseToken) {
          showOutput('deleteOutput', { error: 'Please verify OTP first' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/auth/user`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'Authorization': lastAppToken },
            body: JSON.stringify({ firebaseIdToken: lastFirebaseToken }),
          });
          const data = await res.json();
          showOutput('deleteOutput', data);
        } catch (error) {
          showOutput('deleteOutput', { error: error.message });
        }
      });

      // Products
      document.getElementById('fetchProductsBtn').addEventListener('click', async () => {
        const page = document.getElementById('productsPage').value || 1;
        try {
          const res = await fetch(`${backendBase}/api/products?page=${page}`);
          const data = await res.json();
          showOutput('productsOutput', data);
        } catch (error) {
          showOutput('productsOutput', { error: error.message });
        }
      });

      document.getElementById('getProductByIdBtn').addEventListener('click', async () => {
        const id = document.getElementById('productId').value.trim();
        if (!id) {
          showOutput('productByIdOutput', { error: 'Please enter product ID' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/products/${id}`);
          const data = await res.json();
          showOutput('productByIdOutput', data);
        } catch (error) {
          showOutput('productByIdOutput', { error: error.message });
        }
      });

      // Stores
      document.getElementById('fetchStoresBtn').addEventListener('click', async () => {
        try {
          const res = await fetch(`${backendBase}/api/stores`);
          const data = await res.json();
          showOutput('storesOutput', data);
        } catch (error) {
          showOutput('storesOutput', { error: error.message });
        }
      });

      document.getElementById('fetchTopRatedBtn').addEventListener('click', async () => {
        const limit = document.getElementById('topRatedLimit').value.trim();
        const url = limit ? `${backendBase}/api/stores/top-rated?limit=${limit}` : `${backendBase}/api/stores/top-rated`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          showOutput('topRatedOutput', data);
        } catch (error) {
          showOutput('topRatedOutput', { error: error.message });
        }
      });

      document.getElementById('getStoreProductsBtn').addEventListener('click', async () => {
        const storeId = document.getElementById('storeIdForProducts').value.trim();
        if (!storeId) {
          showOutput('storeProductsOutput', { error: 'Please enter store ID' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/stores/${storeId}/products`);
          const data = await res.json();
          showOutput('storeProductsOutput', data);
        } catch (error) {
          showOutput('storeProductsOutput', { error: error.message });
        }
      });

      // Categories
      document.getElementById('fetchCategoriesBtn').addEventListener('click', async () => {
        try {
          const res = await fetch(`${backendBase}/api/categories`);
          const data = await res.json();
          showOutput('categoriesOutput', data);
        } catch (error) {
          showOutput('categoriesOutput', { error: error.message });
        }
      });

      // Home
      document.getElementById('fetchHomeBtn').addEventListener('click', async () => {
        try {
          const res = await fetch(`${backendBase}/api/home`);
          const data = await res.json();
          showOutput('homeOutput', data);
        } catch (error) {
          showOutput('homeOutput', { error: error.message });
        }
      });

      // Profile
      document.getElementById('getProfileBtn').addEventListener('click', async () => {
        if (!lastAppToken) {
          showOutput('profileOutput', { error: 'Please login first' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/profile`, {
            headers: { 'Authorization': lastAppToken },
          });
          const data = await res.json();
          showOutput('profileOutput', data);
        } catch (error) {
          showOutput('profileOutput', { error: error.message });
        }
      });

      document.getElementById('updateProfileBtn').addEventListener('click', async () => {
        if (!lastAppToken) {
          showOutput('profileOutput', { error: 'Please login first' });
          return;
        }
        const updateData = {};
        const name = document.getElementById('profileNameInput').value.trim();
        const addressName = document.getElementById('profileAddressNameInput').value.trim();
        const addressLong = document.getElementById('profileAddressLongInput').value.trim();
        const addressLat = document.getElementById('profileAddressLatInput').value.trim();
        if (name) updateData.name = name;
        if (addressName) updateData.addressName = addressName;
        if (addressLong) updateData.addressLong = parseFloat(addressLong);
        if (addressLat) updateData.addressLat = parseFloat(addressLat);
        if (Object.keys(updateData).length === 0) {
          showOutput('profileOutput', { error: 'Please fill at least one field' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/profile`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': lastAppToken },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();
          showOutput('profileOutput', data);
        } catch (error) {
          showOutput('profileOutput', { error: error.message });
        }
      });

      // Checkout
      document.getElementById('fillDummyDataBtn').addEventListener('click', () => {
        const phone = document.getElementById('phoneInput').value.trim() || '+201500157920';
        const dummyData = {
          items: [{ id: "1", name: "Ÿàÿ¨ÿ®ÿ© ŸÅÿ±ÿØŸäÿ©", price: 4.5, quantity: 2 }],
          phoneNumber: phone,
          name: "John Doe",
          addressName: "Home Address",
          addressLong: 35.0063,
          addressLat: 29.5320,
          discount: 2.0,
          deliveryFee: 2.5,
          totalAmount: 15.5,
          paymentType: "cash",
          promoCode: "SAVE10",
          storeId: "1",
          nearby: "Near the shopping mall",
          notes: "Please call before delivery"
        };
        document.getElementById('checkoutDataInput').value = JSON.stringify(dummyData, null, 2);
      });

      document.getElementById('createOrderBtn').addEventListener('click', async () => {
        if (!lastAppToken) {
          showOutput('checkoutOutput', { error: 'Please login first' });
          return;
        }
        try {
          const checkoutData = JSON.parse(document.getElementById('checkoutDataInput').value);
          const res = await fetch(`${backendBase}/api/checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': lastAppToken },
            body: JSON.stringify(checkoutData),
          });
          const data = await res.json();
          showOutput('checkoutOutput', data);
        } catch (error) {
          showOutput('checkoutOutput', { error: error.message });
        }
      });

      document.getElementById('getAllOrdersBtn').addEventListener('click', async () => {
        if (!lastAppToken) {
          showOutput('allOrdersOutput', { error: 'Please login first' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/checkout`, {
            headers: { 'Authorization': lastAppToken },
          });
          const data = await res.json();
          showOutput('allOrdersOutput', data);
        } catch (error) {
          showOutput('allOrdersOutput', { error: error.message });
        }
      });

      document.getElementById('getOrderBtn').addEventListener('click', async () => {
        if (!lastAppToken) {
          showOutput('orderByIdOutput', { error: 'Please login first' });
          return;
        }
        const orderId = document.getElementById('orderIdInput').value.trim();
        if (!orderId) {
          showOutput('orderByIdOutput', { error: 'Please enter order ID' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/checkout/${orderId}`, {
            headers: { 'Authorization': lastAppToken },
          });
          const data = await res.json();
          showOutput('orderByIdOutput', data);
        } catch (error) {
          showOutput('orderByIdOutput', { error: error.message });
        }
      });

      document.getElementById('rateOrderBtn').addEventListener('click', async () => {
        if (!lastAppToken) {
          showOutput('rateOrderOutput', { error: 'Please login first' });
          return;
        }
        const orderId = document.getElementById('rateOrderId').value.trim();
        const rating = document.getElementById('orderRating').value;
        if (!orderId) {
          showOutput('rateOrderOutput', { error: 'Please enter order ID' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/checkout/${orderId}/rate`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': lastAppToken },
            body: JSON.stringify({ rating: parseInt(rating) }),
          });
          const data = await res.json();
          showOutput('rateOrderOutput', data);
        } catch (error) {
          showOutput('rateOrderOutput', { error: error.message });
        }
      });

      // Promo Codes
      document.getElementById('validatePromoBtn').addEventListener('click', async () => {
        const code = document.getElementById('promoCodeInput').value.trim();
        if (!code) {
          showOutput('promoOutput', { error: 'Please enter promo code' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/promo-codes/${code}`);
          const data = await res.json();
          showOutput('promoOutput', data);
        } catch (error) {
          showOutput('promoOutput', { error: error.message });
        }
      });

      // Contact
      document.getElementById('getContactBtn').addEventListener('click', async () => {
        try {
          const res = await fetch(`${backendBase}/api/contact`);
          const data = await res.json();
          showOutput('contactOutput', data);
        } catch (error) {
          showOutput('contactOutput', { error: error.message });
        }
      });

      document.getElementById('updateContactBtn').addEventListener('click', async () => {
        if (!lastAppToken) {
          showOutput('updateContactOutput', { error: 'Please login first' });
          return;
        }
        const updateData = {};
        const email = document.getElementById('contactEmail').value.trim();
        const phone = document.getElementById('contactPhone').value.trim();
        if (email) updateData.email = email;
        if (phone) updateData.phone = phone;
        if (Object.keys(updateData).length === 0) {
          showOutput('updateContactOutput', { error: 'Please fill at least one field' });
          return;
        }
        try {
          const res = await fetch(`${backendBase}/api/contact`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': lastAppToken },
            body: JSON.stringify(updateData),
          });
          const data = await res.json();
          showOutput('updateContactOutput', data);
        } catch (error) {
          showOutput('updateContactOutput', { error: error.message });
        }
      });

      // Order Tracking - WebSocket
      let trackingSocket = null;
      let trackingMap = null;
      let driverMarker = null;
      let driverInterval = null;
      let currentRole = null;
      let currentOrderId = null;
      let locationHistory = [];

      // Aqaba, Jordan coordinates
      const aqabaCenter = [29.5320, 35.0063];
      
      // Simulated route through Aqaba (moving from center to different locations)
      const aqabaRoute = [
        [29.5320, 35.0063], // Aqaba Center
        [29.5340, 35.0080],
        [29.5360, 35.0100],
        [29.5380, 35.0120],
        [29.5400, 35.0140],
        [29.5420, 35.0160],
        [29.5440, 35.0180],
        [29.5460, 35.0200],
      ];
      let routeIndex = 0;

      function initMap() {
        if (trackingMap) return;
        
        document.getElementById('mapContainer').style.display = 'block';
        
        trackingMap = L.map('trackingMap').setView(aqabaCenter, 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(trackingMap);

        // Add customer location marker (Aqaba Center - delivery address)
        const customerIcon = L.divIcon({
          html: '<div style="background: #667eea; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
          className: '',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
        
        L.marker(aqabaCenter, { icon: customerIcon })
          .addTo(trackingMap)
          .bindPopup('Delivery Address<br>Aqaba, Jordan');

        // Add driver marker (motorcycle icon)
        const driverIcon = L.divIcon({
          html: '<div class="location-marker">üèçÔ∏è</div>',
          className: '',
          iconSize: [40, 40],
          iconAnchor: [20, 20]
        });
        
        driverMarker = L.marker(aqabaCenter, { icon: driverIcon })
          .addTo(trackingMap)
          .bindPopup('Driver Location');

        document.getElementById('trackingInfo').style.display = 'block';
      }

      function updateMapLocation(lat, lng, timestamp) {
        if (!trackingMap || !driverMarker) return;

        const newLatLng = [lat, lng];
        
        // Smoothly move marker
        driverMarker.setLatLng(newLatLng);
        
        // Calculate bearing for rotation
        if (locationHistory.length > 0) {
          const lastLoc = locationHistory[locationHistory.length - 1];
          const bearing = calculateBearing(
            lastLoc.latitude, 
            lastLoc.longitude, 
            lat, 
            lng
          );
          
          const markerElement = driverMarker.getElement();
          if (markerElement) {
            markerElement.querySelector('.location-marker').style.transform = `rotate(${bearing}deg)`;
          }
        }

        // Pan map to follow driver
        trackingMap.panTo(newLatLng, { animate: true, duration: 1 });

        // Update info
        document.getElementById('lastUpdateTime').textContent = new Date(timestamp).toLocaleTimeString();
        document.getElementById('currentCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        // Add to history
        locationHistory.push({ latitude: lat, longitude: lng, timestamp });
        if (locationHistory.length > 50) {
          locationHistory.shift();
        }
      }

      function calculateBearing(lat1, lon1, lat2, lon2) {
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const lat1Rad = lat1 * Math.PI / 180;
        const lat2Rad = lat2 * Math.PI / 180;
        
        const y = Math.sin(dLon) * Math.cos(lat2Rad);
        const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                  Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
        
        let bearing = Math.atan2(y, x) * 180 / Math.PI;
        bearing = (bearing + 360) % 360;
        return bearing;
      }

      function connectAsDriver() {
        if (!lastAppToken) {
          showStatus('trackingStatus', 'Please login first', 'error');
          return;
        }

        const orderId = document.getElementById('trackingOrderId').value.trim();
        if (!orderId) {
          showStatus('trackingStatus', 'Please enter Order ID', 'error');
          return;
        }

        if (trackingSocket) {
          trackingSocket.disconnect();
        }

        currentOrderId = parseInt(orderId);
        currentRole = 'driver';

        trackingSocket = io(backendBase, {
          auth: {
            token: lastAppToken,
            orderId: currentOrderId
          }
        });

        trackingSocket.on('connect', () => {
          showStatus('trackingStatus', 'Connected as Driver', 'success');
          
          // Initialize map
          initMap();
          
          // Start sending location updates every 3 seconds
          routeIndex = 0;
          driverInterval = setInterval(() => {
            if (!trackingSocket || !trackingSocket.connected) {
              clearInterval(driverInterval);
              return;
            }

            // Move along route (cycling back)
            const location = aqabaRoute[routeIndex % aqabaRoute.length];
            const [lat, lng] = location;
            
            // Add slight random variation for realism
            const latWithVariation = lat + (Math.random() - 0.5) * 0.001;
            const lngWithVariation = lng + (Math.random() - 0.5) * 0.001;

            trackingSocket.emit('driver_location', {
              longitude: lngWithVariation,
              latitude: latWithVariation
            });

            // Update route index
            routeIndex++;
          }, 3000);

          // Send first location immediately
          const firstLocation = aqabaRoute[0];
          trackingSocket.emit('driver_location', {
            longitude: firstLocation[1],
            latitude: firstLocation[0]
          });
        });

        trackingSocket.on('connected', (data) => {
          showOutput('trackingOutput', { event: 'connected', data });
        });

        trackingSocket.on('location_sent', (data) => {
          showOutput('trackingOutput', { event: 'location_sent', data, timestamp: new Date().toISOString() });
        });

        trackingSocket.on('error', (error) => {
          showStatus('trackingStatus', `Error: ${error.message}`, 'error');
          showOutput('trackingOutput', { event: 'error', error });
        });

        trackingSocket.on('disconnect', () => {
          showStatus('trackingStatus', 'Disconnected', 'info');
          if (driverInterval) {
            clearInterval(driverInterval);
            driverInterval = null;
          }
        });
      }

      function connectAsCustomer() {
        if (!lastAppToken) {
          showStatus('trackingStatus', 'Please login first', 'error');
          return;
        }

        const orderId = document.getElementById('trackingOrderId').value.trim();
        if (!orderId) {
          showStatus('trackingStatus', 'Please enter Order ID', 'error');
          return;
        }

        if (trackingSocket) {
          trackingSocket.disconnect();
        }

        currentOrderId = parseInt(orderId);
        currentRole = 'customer';

        trackingSocket = io(backendBase, {
          auth: {
            token: lastAppToken,
            orderId: currentOrderId
          }
        });

        trackingSocket.on('connect', () => {
          showStatus('trackingStatus', 'Connected as Customer - Waiting for driver location...', 'success');
          
          // Initialize map
          initMap();
        });

        trackingSocket.on('connected', (data) => {
          showOutput('trackingOutput', { event: 'connected', data });
          
          if (data.lastLocation) {
            updateMapLocation(
              data.lastLocation.latitude,
              data.lastLocation.longitude,
              data.lastLocation.timestamp
            );
          }
        });

        trackingSocket.on('location_update', (data) => {
          showOutput('trackingOutput', { event: 'location_update', data, timestamp: new Date().toISOString() });
          updateMapLocation(data.latitude, data.longitude, data.timestamp);
        });

        trackingSocket.on('error', (error) => {
          showStatus('trackingStatus', `Error: ${error.message}`, 'error');
          showOutput('trackingOutput', { event: 'error', error });
        });

        trackingSocket.on('disconnect', () => {
          showStatus('trackingStatus', 'Disconnected', 'info');
        });
      }

      function disconnectTracking() {
        if (trackingSocket) {
          trackingSocket.disconnect();
          trackingSocket = null;
        }
        
        if (driverInterval) {
          clearInterval(driverInterval);
          driverInterval = null;
        }

        showStatus('trackingStatus', 'Disconnected', 'info');
        currentRole = null;
        currentOrderId = null;
        locationHistory = [];
      }

      document.getElementById('connectAsDriverBtn').addEventListener('click', connectAsDriver);
      document.getElementById('connectAsCustomerBtn').addEventListener('click', connectAsCustomer);
      document.getElementById('disconnectTrackingBtn').addEventListener('click', disconnectTracking);

      setupVerifier();
    }

    bootstrap().catch((error) => {
      console.error("Failed to initialize Firebase", error);
      document.getElementById('registerStatus').textContent = "Unable to initialize Firebase SDK";
      document.getElementById('registerStatus').className = 'status error';
      document.getElementById('registerStatus').style.display = 'block';
    });
  </script>
</body>
</html>
