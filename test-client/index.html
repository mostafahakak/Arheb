<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phone OTP Tester</title>
  <style>
    body {
      font-family: system-ui, "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    main {
      width: min(680px, 100%);
      background: white;
      border-radius: 18px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }

    .field {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.35rem;
    }

    input,
    textarea {
      font-size: 1rem;
      width: 100%;
      padding: 0.65rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
    }

    button {
      font-size: 1rem;
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #4b5563;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    #status,
    #verifyResult {
      min-height: 2rem;
      font-size: 0.95rem;
      color: #1f2937;
    }

    #sessionInfo,
    #sessionInfoOutput {
      background: #f8fafc;
      border-radius: 8px;
      padding: 0.65rem;
      min-height: 2.25rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    #recaptcha-container {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <main>
    <h1>Firebase OTP tester</h1>
    <p>
      This page obtains a reCAPTCHA token for your phone test number and hits your backend.
      Add <code>+201500157920</code> as a Firebase test number with OTP <strong>111111</strong>.
    </p>

    <div class="field">
      <label for="phoneInput">Phone number</label>
      <input id="phoneInput" value="+201500157920" />
    </div>

    <div class="field row">
      <button id="sendOtpBtn">Request OTP via backend</button>
    </div>

    <div class="field">
      <label>Last status</label>
      <div id="status">idle</div>
    </div>

    <div class="field">
      <label>Register response</label>
      <div id="sessionInfoOutput">(waiting for response)</div>
    </div>

    <div class="field">
      <label for="sessionInfoInput">Session info (paste only the sessionInfo value if needed)</label>
      <textarea id="sessionInfoInput" rows="3"></textarea>
    </div>

    <div class="field">
      <label for="otpInput">OTP (test value: 111111)</label>
      <div class="row">
        <input id="otpInput" value="111111" />
        <button id="verifyOtpBtn" class="secondary">Verify OTP</button>
      </div>
    </div>

    <div class="field">
      <label>Delete user</label>
      <div class="row">
        <button id="deleteUserBtn" class="secondary">Delete registered user</button>
      </div>
      <div id="deleteStatus">(requires verification first)</div>
    </div>

    <div class="field">
      <label>Verify response</label>
      <div id="verifyResult">(waiting)</div>
    </div>

    <div class="field">
      <label>Categories preview</label>
      <div class="row">
        <button id="fetchCategoriesBtn" class="secondary">
          Fetch `/api/categories`
        </button>
      </div>
      <pre id="categoriesOutput">(no data yet)</pre>
    </div>

    <div class="field">
      <label>Products preview</label>
      <div class="row">
        <button id="fetchProductsBtn" class="secondary">
          Fetch `/api/products`
        </button>
      </div>
      <pre id="productsOutput">(no data yet)</pre>
    </div>

    <div class="field">
      <label>Home preview</label>
      <div class="row">
        <button id="fetchHomeBtn" class="secondary">
          Fetch `/api/home`
        </button>
      </div>
      <pre id="homeOutput">(no data yet)</pre>
    </div>

    <div class="field">
      <label>Stores preview</label>
      <div class="row">
        <button id="fetchStoresBtn" class="secondary">
          Fetch `/api/stores`
        </button>
      </div>
      <pre id="storesOutput">(no data yet)</pre>
    </div>

    <div class="field">
      <label>Profile API (requires login)</label>
      <div class="row">
        <button id="getProfileBtn" class="secondary">Get Profile</button>
        <button id="updateProfileBtn" class="secondary">Update Profile</button>
      </div>
      <pre id="profileOutput">(requires login first)</pre>
      <div style="margin-top: 0.5rem;">
        <input id="profileNameInput" placeholder="Name" style="margin-bottom: 0.5rem;" />
        <input id="profileAddressNameInput" placeholder="Address Name" style="margin-bottom: 0.5rem;" />
        <input id="profileAddressLongInput" placeholder="Address Longitude" type="number" step="any" style="margin-bottom: 0.5rem;" />
        <input id="profileAddressLatInput" placeholder="Address Latitude" type="number" step="any" />
      </div>
    </div>

    <div class="field">
      <label>Checkout API (requires login)</label>
      <div class="row">
        <button id="fillDummyDataBtn" class="secondary">Fill Dummy Data</button>
        <button id="createOrderBtn" class="secondary">Create Order</button>
      </div>
      <pre id="checkoutOutput">(requires login first)</pre>
      <textarea id="checkoutDataInput" rows="10" placeholder='{"items": [{"id": "1", "name": "Product", "price": 10.5, "quantity": 2}], "phoneNumber": "+201500157920", "name": "John Doe", "addressName": "Home", "addressLong": 35.0063, "addressLat": 29.5320, "totalAmount": 21.0, "paymentType": "cash"}' style="margin-top: 0.5rem;"></textarea>
      <div class="row" style="margin-top: 0.5rem;">
        <input id="orderIdInput" type="number" placeholder="Order ID" style="flex: 1;" />
        <button id="getOrderBtn" class="secondary">Get Order</button>
      </div>
    </div>

    <div id="recaptcha-container"></div>
  </main>

  <script>
    const sdkUrls = [
      "./vendor/firebase-app-compat.js",
      "./vendor/firebase-auth-compat.js",
    ];
    const backendBase = window.location.origin;
    let lastAppToken = "";
    let lastFirebaseToken = "";
    let deleteStatus;

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const tag = document.createElement("script");
        tag.src = url;
        tag.onload = resolve;
        tag.onerror = () => reject(new Error(`failed to load ${url}`));
        document.head.appendChild(tag);
      });
    }

    async function bootstrap() {
      for (const url of sdkUrls) {
        await loadScript(url);
      }

      const firebaseConfig = {
        apiKey: "AIzaSyA_rR3EE0ncBTdkRrpOrYy7S1nQXjvf5EQ",
        authDomain: "arheb-bd219.firebaseapp.com",
        projectId: "arheb-bd219",
        storageBucket: "arheb-bd219.appspot.com",
        messagingSenderId: "1050116933276",
        appId: "1:1050116933276:web:abdeb6b2f3e13409a00f59",
      };

      firebase.initializeApp(firebaseConfig);

      const phoneInput = document.getElementById("phoneInput");
      const statusEl = document.getElementById("status");
      const sessionInfoOutput = document.getElementById("sessionInfoOutput");
      const sessionInfoInput = document.getElementById("sessionInfoInput");
      const verifyResult = document.getElementById("verifyResult");
      const otpInput = document.getElementById("otpInput");
      deleteStatus = document.getElementById("deleteStatus");
      const profileOutput = document.getElementById("profileOutput");
      const checkoutOutput = document.getElementById("checkoutOutput");

      let verifier;

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? "#be123c" : "#1f2937";
      }

      function setupVerifier() {
        if (verifier) {
          verifier.clear();
        }

        verifier = new firebase.auth.RecaptchaVerifier("recaptcha-container", {
          size: "normal",
          callback: () => {
            // will be handled in request flow
          },
        });

        verifier.render().catch((error) => {
          console.error("recaptcha render failed", error);
        });
      }

      async function requestRegister() {
        if (!verifier) {
          setStatus(
            "reCAPTCHA verifier not ready—check your console or reload the page.",
            true
          );
          return;
        }

        console.log("Requesting register for", phoneInput.value);
        setStatus("Preparing reCAPTCHA...");
        try {
          const recaptchaToken = await verifier.verify();
          console.log("reCAPTCHA token obtained", recaptchaToken);
          setStatus("Sending request to backend...");
        const response = await fetch(`${backendBase}/api/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              phoneNumber: phoneInput.value.trim(),
              recaptchaToken,
            }),
          });

        const data = await response.json();
          setStatus(
            response.ok ? data.message || "OTP request sent" : data.message || "Failed"
          );
          sessionInfoOutput.textContent = JSON.stringify(data, null, 2);
          if (data.sessionInfo) {
            sessionInfoInput.value = data.sessionInfo;
          }
        } catch (error) {
          console.error(error);
          setStatus("Error: " + error.message, true);
        } finally {
          setupVerifier();
        }
      }

      async function verifyOtp() {
        const sessionInfo = sessionInfoInput.value.trim();
        if (!sessionInfo) {
          verifyResult.textContent =
            "Paste the sessionInfo from the register response first.";
          return;
        }

        try {
          console.log("Verifying OTP for sessionInfo", sessionInfo);
          verifyResult.textContent = "Verifying OTP...";
        const response = await fetch(`${backendBase}/api/auth/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              phoneNumber: phoneInput.value.trim(),
              sessionInfo,
              otp: otpInput.value.trim(),
            }),
          });

        const data = await response.json();
          verifyResult.textContent = JSON.stringify(data, null, 2);
        if (data.success) {
          lastAppToken = data.token;
          lastFirebaseToken = data.firebaseToken ?? "";
          deleteStatus.textContent = data.token
            ? "Ready to delete – token stored"
            : "(JWT missing)";
          profileOutput.textContent = "Logged in! Token saved. Click Get Profile or Update Profile to test.";
          checkoutOutput.textContent = "Logged in! Token saved. Fill in order data and click Create Order to test.";
        }
        } catch (error) {
          console.error(error);
          verifyResult.textContent = "Error: " + error.message;
        }
      }

      document
        .getElementById("sendOtpBtn")
        .addEventListener("click", requestRegister);
      document
        .getElementById("verifyOtpBtn")
        .addEventListener("click", verifyOtp);
      document
        .getElementById("fetchCategoriesBtn")
        .addEventListener("click", fetchCategories);
      document
        .getElementById("fetchProductsBtn")
        .addEventListener("click", () => fetchPreview('/api/products', 'productsOutput'));
      document
        .getElementById("fetchHomeBtn")
        .addEventListener("click", () => fetchPreview('/api/home', 'homeOutput'));
      document
        .getElementById("fetchStoresBtn")
        .addEventListener("click", () => fetchPreview('/api/stores', 'storesOutput'));
      async function deleteUser() {
        console.log("Delete button clicked", { lastAppToken: !!lastAppToken, lastFirebaseToken: !!lastFirebaseToken });
        if (!lastAppToken || !lastFirebaseToken) {
          deleteStatus.textContent =
            "Verify OTP first so we can store your tokens.";
          return;
        }

        deleteStatus.textContent = "Deleting user...";
        try {
          console.log("Sending delete request...");
          const response = await fetch(`${backendBase}/api/auth/user`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              Authorization: lastAppToken,
            },
            body: JSON.stringify({
              firebaseIdToken: lastFirebaseToken,
            }),
          });
          const data = await response.json();
          console.log("Delete response:", data);
          deleteStatus.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          console.error("Delete error:", error);
          deleteStatus.textContent = "Error: " + error.message;
        }
      }

      document
        .getElementById("deleteUserBtn")
        .addEventListener("click", deleteUser);

      async function getProfile() {
        if (!lastAppToken) {
          profileOutput.textContent = "Please login first by verifying OTP.";
          return;
        }

        profileOutput.textContent = "Fetching profile...";
        try {
          const response = await fetch(`${backendBase}/api/profile`, {
            method: "GET",
            headers: {
              "Authorization": lastAppToken
            }
          });
          const data = await response.json();
          profileOutput.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          console.error(error);
          profileOutput.textContent = "Error: " + error.message;
        }
      }

      async function updateProfile() {
        if (!lastAppToken) {
          profileOutput.textContent = "Please login first by verifying OTP.";
          return;
        }

        const name = document.getElementById("profileNameInput").value.trim() || null;
        const addressName = document.getElementById("profileAddressNameInput").value.trim() || null;
        const addressLong = document.getElementById("profileAddressLongInput").value.trim();
        const addressLat = document.getElementById("profileAddressLatInput").value.trim();

        const updateData = {};
        if (name) updateData.name = name;
        if (addressName) updateData.addressName = addressName;
        if (addressLong) updateData.addressLong = parseFloat(addressLong);
        if (addressLat) updateData.addressLat = parseFloat(addressLat);

        if (Object.keys(updateData).length === 0) {
          profileOutput.textContent = "Please fill in at least one field to update.";
          return;
        }

        profileOutput.textContent = "Updating profile...";
        try {
          const response = await fetch(`${backendBase}/api/profile`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "Authorization": lastAppToken
            },
            body: JSON.stringify(updateData)
          });
          const data = await response.json();
          profileOutput.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          console.error(error);
          profileOutput.textContent = "Error: " + error.message;
        }
      }

      function fillDummyData() {
        const dummyData = {
          items: [
            {
              id: "1",
              name: "وجبة فردية",
              price: 4.5,
              quantity: 2
            },
            {
              id: "2",
              name: "برجر كلاسيك",
              price: 6.0,
              quantity: 1
            }
          ],
          phoneNumber: phoneInput.value.trim() || "+201500157920",
          name: "John Doe",
          addressName: "Home Address",
          addressLong: 35.0063,
          addressLat: 29.5320,
          discount: 2.0,
          deliveryFee: 2.5,
          totalAmount: 15.5,
          paymentType: "cash",
          nearby: "Near the shopping mall",
          notes: "Please call before delivery"
        };
        
        document.getElementById("checkoutDataInput").value = JSON.stringify(dummyData, null, 2);
        checkoutOutput.textContent = "Dummy data filled! Click Create Order to submit.";
      }

      async function getOrder() {
        if (!lastAppToken) {
          checkoutOutput.textContent = "Please login first by verifying OTP.";
          return;
        }

        const orderId = document.getElementById("orderIdInput").value.trim();
        if (!orderId) {
          checkoutOutput.textContent = "Please enter an Order ID.";
          return;
        }

        checkoutOutput.textContent = "Fetching order...";
        try {
          const response = await fetch(`${backendBase}/api/checkout/${orderId}`, {
            method: "GET",
            headers: {
              "Authorization": lastAppToken
            }
          });
          const data = await response.json();
          checkoutOutput.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          console.error(error);
          checkoutOutput.textContent = "Error: " + error.message;
        }
      }

      async function createOrder() {
        if (!lastAppToken) {
          checkoutOutput.textContent = "Please login first by verifying OTP.";
          return;
        }

        const checkoutDataText = document.getElementById("checkoutDataInput").value.trim();
        if (!checkoutDataText) {
          checkoutOutput.textContent = "Please provide order data in JSON format or click Fill Dummy Data.";
          return;
        }

        let checkoutData;
        try {
          checkoutData = JSON.parse(checkoutDataText);
        } catch (error) {
          checkoutOutput.textContent = "Invalid JSON format: " + error.message;
          return;
        }

        checkoutOutput.textContent = "Creating order...";
        try {
          const response = await fetch(`${backendBase}/api/checkout`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": lastAppToken
            },
            body: JSON.stringify(checkoutData)
          });
          const data = await response.json();
          checkoutOutput.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          console.error(error);
          checkoutOutput.textContent = "Error: " + error.message;
        }
      }

      document
        .getElementById("getProfileBtn")
        .addEventListener("click", getProfile);
      document
        .getElementById("updateProfileBtn")
        .addEventListener("click", updateProfile);
      document
        .getElementById("fillDummyDataBtn")
        .addEventListener("click", fillDummyData);
      document
        .getElementById("createOrderBtn")
        .addEventListener("click", createOrder);
      document
        .getElementById("getOrderBtn")
        .addEventListener("click", getOrder);

      window.addEventListener("load", () => {
        setupVerifier();
      });
    }

    async function fetchCategories() {
      await fetchPreview('/api/categories', 'categoriesOutput');
    }

    async function fetchPreview(endpoint, outputId) {
      const output = document.getElementById(outputId);
      output.textContent = `Loading ${endpoint}...`;
      try {
        const response = await fetch(`${window.location.origin}${endpoint}`);
        const data = await response.json();
        output.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        console.error(error);
        output.textContent = "Error: " + error.message;
      }
    }

    bootstrap().catch((error) => {
      console.error("Failed to initialize Firebase tester", error);
      const statusEl = document.getElementById("status");
      if (statusEl) {
        statusEl.textContent = "Unable to initialize Firebase SDK";
        statusEl.style.color = "#be123c";
      }
    });
  </script>
</body>
</html>

